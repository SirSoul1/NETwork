{% extends "blog/base.html" %}
{% block content %}
<div class="container mx-auto my-8 px-4">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <!-- Post Author and Date -->
            <div class="flex items-center mb-4">
                <img src="{{ object.author.profile.image.url }}" 
                        class="w-12 h-12 rounded-full object-cover" 
                        alt="Profile picture of {{ object.author }}">
            </div>
            <div class="flex-grow-1">
                <h4 class="text-gray-700 mb-2">{{ object.title }}</h4>
                <p class="text-muted mb-1">
                    <small><a href="{% url 'user-posts' object.author.username %}">{{ object.author }} </a> - {{ object.date_posted|date:"D d M Y" }}</small>
                {% if object.author == user %}
                    <div>
                        <a class="btn btn-secondary btn-sm mt-1 mb-1" href="{% url 'post-update' object.id %}"> Update</a>
                        <a class="btn btn-danger btn-sm mt-1 mb-1" href="{% url 'post-delete' object.id %}"> Delete</a>
                    </div>
                {% endif %}   
                </p>




                <!-- Post Content -->
                <div class="text-gray-700 mb-4">
                    <p>{{ object.content }}</p>
                </div>
        
                <!-- Display Image -->
                {% if post.image %}
                <div class="my-4">
                    <img src="{{ post.image.url }}" alt="Image for {{ post.title }}" class="w-full max-w-lg mx-auto rounded-lg shadow-md">
                </div>
                {% endif %}
        
                <!-- Display Video -->
                {% if post.video %}
                <div class="my-4">
                    <video class="w-full max-w-lg mx-auto rounded-lg shadow-md" controls>
                        <source src="{{ post.video.url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
                {% endif %}
        
                <!-- Display YouTube Video -->
                {% if post.youtube_url %}
                <div class="my-4">
                    <iframe class="w-full max-w-lg mx-auto rounded-lg shadow-md" height="315" src="{{ post.get_youtube_embed_url }}" frameborder="0" allowfullscreen></iframe>
                </div>
                {% endif %}
            </div>
    </div>


    <!-- Like Button -->
    <div class="flex items-center justify-start">
        <form method="POST" class="like-form inline-flex items-center" data-post-id="{{ object.id }}" data-url="{% url 'like-post' object.id %}">
            {% csrf_token %}
            <div class="heart {% if user in object.likes.all %}is-active{% endif %} "></div>
        </form>
        <span id="like-count" class="text-gray-600">{{ object.total_likes }} Likes</span>
    </div>

    <!-- Comments Section -->
    <div class="row">
        <div class="col-12">
            <div class="content-section">
                <h3>Comments</h3><br>
                {% for comment in comments %}
                    <div class="media mb-4">
                        <img class="rounded-circle article-img" src="{{ comment.author.profile.image.url }}" alt="Profile picture of {{ comment.author }}" style="width: 50px; height: 50px; object-fit: cover;">
                        <div class="media-body">
                            <h5 class="mt-0"><a href="{% url 'profile-view' comment.author.username %}">{{ comment.author }}</a></h5>
                            <p>{{ comment.content }}</p>
                            <small class="text-muted">{{ comment.date_posted|date:"F d, Y H:i" }}</small>
                            <a href="#" class="reply-link" data-comment-id="{{ comment.id }}">Reply</a>

                            <!-- Nested Replies -->
                            {% for reply in comment.replies.all %}
                                <div class="media mt-4">
                                    <img class="rounded-circle article-img" src="{{ reply.author.profile.image.url }}" alt="Profile picture of {{ reply.author }}" style="width: 40px; height: 40px; object-fit: cover;">
                                    <div class="media-body">
                                        <h6 class="mt-0"><a href="{% url 'profile-view' reply.author.username %}">{{ reply.author }}</a></h6>
                                        <p>{{ reply.content }}</p>
                                        <small class="text-muted">{{ reply.date_posted|date:"F d, Y H:i" }}</small>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% empty %}
                    <p>No comments yet. Be the first to comment!</p>
                {% endfor %}
            </div>

            {% if user.is_authenticated %}
                <div class="content-section">
                    <h3>Leave a Comment</h3>
                    <form method="POST">
                        {% csrf_token %}
                        {{ comment_form.as_p }}
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>        
                </div>
            {% else %}
                <p>You must be <a href="{% url 'login' %}">logged in</a> to leave a comment.</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
    var csrfToken = '{{ csrf_token }}';
    // Simple JavaScript to set the parent ID in the reply form
    document.querySelectorAll('.reply-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const commentId = this.getAttribute('data-comment-id');
            document.querySelector('#id_parent').value = commentId;
            window.scrollTo(0, document.body.scrollHeight);  // Scroll to form
        });
    });
</script>

{% endblock content %}
